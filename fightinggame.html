<!DOCTYPE HTML>
<html>

<head>
    <title>Fighting Game</title>
    <link rel="icon" type="image/x-icon" href="./images/fav.png">
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
    <link rel="stylesheet" href="assets/css/main.css" />
    <noscript>
        <link rel="stylesheet" href="assets/css/noscript.css" />
    </noscript>
</head>

<body class="is-preload">
    <div id="page-wrapper">

        <!-- Header -->
        <header id="header">
            <h1 id="logo"><a href="index.html"><img style="vertical-align:middle;margin-bottom: 10px" height=30px
                        width=30px src="images/fav.png" /> R. Zhao</a>
            </h1>
            <nav id="nav">
                <ul>
                    <li><a href="index.html">Home</a></li>
                    <li><a href="projects.html">Projects</a></li>
                    <li><a href="about.html">About Me</a></li>
                    <li><a href="funstuff.html">Fun Stuff</a></li>
                </ul>
            </nav>
        </header>

        <!-- Main -->
        <div id="main" class="wrapper style1">
            <div class="container">
                <header class="major">
                    <h2>⚔️ Turn-Based Fighting Game</h2>
                </header>
                <h3>Inspiration</h3>
                <p>I'm a big fan of turn-based games where you have to think several steps ahead of your opponent. I
                    decided to build this engine after completing my functional programming course in college.</p>

                <h3>JSON Parsing</h3>
                <p>I wanted to apply my knowledge of functors to generalize the JSON parsing of my game. As shown below,
                    there was a lot of code duplication only because I was trying to read 2 different JSON files with
                    slightly different schemas.</p>
                <h4>Creature JSON</h4>
                <pre>
<code>let creature_json f =
  let json =
    try Yojson.Basic.from_file f with
    | Sys_error _ -> raise Not_found
  in
  json |> to_assoc |> List.assoc "creatures" |> to_list
  
let creature_json_assoc n =
  creature_json_with_name n
    (creature_json ("creatures_data" ^ Filename.dir_sep ^ "creatures.json"))
</code>
                </pre>
                <h4>Move JSON</h4>
                <pre>
<code>let move_json f =
  let json =
    try Yojson.Basic.from_file f with
    | Sys_error _ -> raise Not_found
  in
  json |> to_assoc |> List.assoc "moves" |> to_list
  
let move_json_assoc n =
  move_json_with_name n (move_json ("moves_data" ^ Filename.dir_sep ^ "moves.json"))
</code>                    
                </pre>
                <p>Instead, I made a module type that defined which file to look at and which field(s) to look at. This
                    is shown below with <code>AdaptableJSONData</code>. Then, I
                    made a functor called <code>GetData (Data : AdaptableJSONData)</code> that gets certain values from
                    the JSON file. Because the 2 files have very similar schemas and structures, I was able to
                    pre-emptively determine what the types were, so I could call functions that assume type (like
                    <code>Yojson.Basic.Util.to_bool</code> and <code>Yojson.Basic.Util.to_float</code>). The full JSON
                    parsing code
                    can be found
                    <a href="https://github.com/robertzhao2002/Turn-based-Fighting-Game/blob/rework-accuracy-and-add-critical-hit/util/json.ml"
                        target="_blank">here</a>. To see this in action in the creature module, look <a
                        href="https://github.com/robertzhao2002/Turn-based-Fighting-Game/blob/rework-accuracy-and-add-critical-hit/creature/core.ml#L27"
                        target="_blank">here</a>.
                </p>
                <pre>
<code >module type AdaptableJSONData = sig
    val main_field_name : string
    val object_name : string
    val json_file : string
end</code>
                    </pre>
                <h3>OCaml CICD</h3>
                <h4>Dependencies</h4>
                <p>I wanted to centralize the file containing dependency information in order for the virtual machine on
                    Github Actions to install all the necessary dependencies for the CI tasks. To do this, we need to
                    modify the <code>dune-project</code> file in the top-level. This allows the <code>Game.opam</code>
                    file to be autogenerated and it will contain the correct build configurations.</p>
                <pre>
<code>(lang dune 2.9)

(name Game)

(generate_opam_files true)

(package
  (name Game)
  (depends
    (ANSITerminal
      (>= 0.8.5))
    (ocaml
      (>= 4.02.3))
    (odoc
      (>= 2.1.1))
    (ounit2
      (>= 2.2.6))
    (yojson
      (>= 2.0.2))
    dune))
</code>                    
                </pre>
                <h4>Workflow</h4>
                <p>I wanted to run all my unit tests every time before I merge a large change. This was also a way
                    for me to practice using some OCaml CICD. Below is a portion of the YAML workflow file. We first set
                    up OCaml with the <a href="https://github.com/marketplace/actions/set-up-ocaml" target="_blank">Set
                        up OCaml</a> Github Action. Then, we need to install all of the necessary dependencies of our
                    project. Because we have centralized our dependencies into <code>Game.opam</code>, this has become
                    very easy. The <code>--deps-only</code> tag allows OPAM to look into our <code>Game.opam</code> and
                    install those dependencies with those versions. After this, we essentially created a virtual OCaml
                    enviroment to run our code on. We can execute the commands to run all of our unit tests and compile
                    the program. If any of these throw errors, it will have a non-zero exit code, which will show up as
                    a CI failure on our pull request. We can essentially rely on this tool to help make sure we aren't
                    breaking the code when we add big changes.</p>
                <pre>
<code>steps:
    - name: Checkout Repository
      uses: actions/checkout@v3
    - name: Set up OCaml
      uses: ocaml/setup-ocaml@v1.1.11
      with:
          ocaml-compiler: 4.14.x
    - name: Install OCaml Dependencies
      run: opam install . --deps-only --with-test
</code>
                    </pre>
                <h3>REPL</h3>
                <p>This is the state machine for my game. In functional programming, it makes state handling much easier
                    to be aware of what kinds of events causes the state to change. Have a function read the state and
                    display stuff accordingly.</p>
                <svg style="fill: white;" height="50%" width="50%" version="1.1" xmlns="http://www.w3.org/2000/svg"
                    viewBox="0 0 771 542">
                    <ellipse stroke="white" stroke-width="1" fill="none" cx="58.5" cy="157.5" rx="40" ry="40" />
                    <text x="41.5" y="163.5" font-family="Times New Roman" font-size="20">start</text>
                    <ellipse stroke="white" stroke-width="1" fill="none" cx="457.5" cy="157.5" rx="40" ry="40" />
                    <text x="429.5" y="163.5" font-family="Times New Roman" font-size="20">attacks</text>
                    <ellipse stroke="white" stroke-width="1" fill="none" cx="729.5" cy="322.5" rx="40" ry="40" />
                    <text x="707.5" y="328.5" font-family="Times New Roman" font-size="20">death</text>
                    <ellipse stroke="white" stroke-width="1" fill="none" cx="58.5" cy="500.5" rx="40" ry="40" />
                    <text x="36.5" y="506.5" font-family="Times New Roman" font-size="20">menu</text>
                    <ellipse stroke="white" stroke-width="1" fill="none" cx="457.5" cy="500.5" rx="40" ry="40" />
                    <text x="429.5" y="506.5" font-family="Times New Roman" font-size="20">winner</text>
                    <ellipse stroke="white" stroke-width="1" fill="none" cx="457.5" cy="500.5" rx="34" ry="34" />
                    <ellipse stroke="white" stroke-width="1" fill="none" cx="319.5" cy="42.5" rx="40" ry="40" />
                    <text x="303.5" y="48.5" font-family="Times New Roman" font-size="20">quit</text>
                    <ellipse stroke="white" stroke-width="1" fill="none" cx="319.5" cy="42.5" rx="34" ry="34" />
                    <polygon stroke="white" stroke-width="1" points="58.5,197.5 58.5,460.5" />
                    <polygon fill="white" stroke-width="1" points="58.5,460.5 63.5,452.5 53.5,452.5" />
                    <text x="1.5" y="335.5" font-family="Times New Roman" font-size="20">switch</text>
                    <polygon stroke="white" stroke-width="1" points="457.5,197.5 457.5,460.5" />
                    <polygon fill="white" stroke-width="1" points="457.5,460.5 462.5,452.5 452.5,452.5" />
                    <text x="291.5" y="335.5" font-family="Times New Roman" font-size="20">surrender, last death</text>
                    <path stroke="white" stroke-width="1" fill="none"
                        d="M 691.902,308.864 A 711.539,711.539 0 0 1 486.964,184.545" />
                    <polygon fill="white" stroke-width="1" points="486.964,184.545 489.731,193.564 496.284,186.01" />
                    <text x="467.5" y="276.5" font-family="Times New Roman" font-size="20">revive, switch</text>
                    <polygon stroke="white" stroke-width="1" points="98.5,157.5 417.5,157.5" />
                    <polygon fill="white" stroke-width="1" points="417.5,157.5 409.5,152.5 409.5,162.5" />
                    <text x="206.5" y="148.5" font-family="Times New Roman" font-size="20">pick creature</text>
                    <polygon stroke="white" stroke-width="1" points="696.03,344.403 490.97,478.597" />
                    <polygon fill="white" stroke-width="1" points="490.97,478.597 500.402,478.4 494.926,470.032" />
                    <text x="598.5" y="432.5" font-family="Times New Roman" font-size="20">surrender</text>
                    <polygon stroke="white" stroke-width="1" points="95.104,141.372 282.896,58.628" />
                    <polygon fill="white" stroke-width="1" points="282.896,58.628 273.559,57.278 277.591,66.43" />
                    <text x="59.5" y="90.5" font-family="Times New Roman" font-size="20">preemptive quit</text>
                    <polygon stroke="white" stroke-width="1" points="98.5,500.5 417.5,500.5" />
                    <polygon fill="white" stroke-width="1" points="417.5,500.5 409.5,495.5 409.5,505.5" />
                    <text x="220.5" y="521.5" font-family="Times New Roman" font-size="20">surrender</text>
                    <path stroke="white" stroke-width="1" fill="none"
                        d="M 495.171,170.934 A 693.089,693.089 0 0 1 700.182,295.297" />
                    <polygon fill="white" stroke-width="1" points="700.182,295.297 697.456,286.266 690.869,293.789" />
                    <text x="607.5" y="215.5" font-family="Times New Roman" font-size="20">creature(s) remain</text>
                    <polygon stroke="white" stroke-width="1" points="88.833,474.425 427.167,183.575" />
                    <polygon fill="white" stroke-width="1" points="427.167,183.575 417.841,184.999 424.36,192.582" />
                    <text x="92.5" y="320.5" font-family="Times New Roman" font-size="20">select valid creature</text>
                    <path stroke="white" stroke-width="1" fill="none"
                        d="M 461.36,117.844 A 30,30 0 1 1 491.325,136.442" />
                    <text x="509.5" y="72.5" font-family="Times New Roman" font-size="20">use attack</text>
                    <polygon fill="white" stroke-width="1" points="491.325,136.442 500.62,138.053 496.846,128.793" />
                </svg>
                <br />
                <br />
                <p>The equivalent of these events can be seen in the type definitions below. The action type corresponds
                    to the arrows in the FSM. <code>MoveUsed</code> corresponds to using an attack. The "attacks" state
                    corresponds to <code>Battle</code> and <code>CreatureDead</code> corresponds to "death." The menu is
                    a state for the REPL to display the list of creatures. It will be recognized with the
                    <code>Switch</code> action is triggered.
                </p>
                <pre>
<code>type action =
  | Switch of string
  | MoveUsed of string
  | Revive of string
  | Surrender
</code>
                </pre>
                <pre>
<code>type result =
  | Battle
  | CreatureDead of bool
  | Trainer1Win of string * string
  | Trainer2Win of string * string
</code>
                </pre>
                <h3>Plans for the Future</h3>
                <h4>AI</h4>
                <p>Because this is a turn-based game, there is always the possibility of including some sort of mode
                    where you can go against the computer, like an "AI." This would involve creating a data structure
                    that acts like a decision tree. I can set a difficulty rating based on how many moves ahead the
                    computer should consider, which is essentially how many layers down the tree the program should
                    evaluate.</p>
                <h4>Bans</h4>
                <p>In many of these kinds of games, each player can choose a single creature they don't want their
                    opponent to use. This is called a "ban." Implementing this shouldn't be too much of a challenge.
                    Have the game state hold information about the creature that each player wants banned, and the
                    program should check that the player isn't selecting a banned creature.</p>

                <h4>Wacky Debuffs</h4>
                <p>A debuff is essentially a cool side-effect that an attack may have after it has been used. A
                    side-effect means anything that may happen in addition to the baseline damage being dealt. Examples
                    can be life steal (dealing damage and healing oneself), critical hit (a small chance of doing
                    significantly more damage with no cost), and more. As of right now, I don't have a good way of
                    consolidating all of the possible debuffs that a move may inflict. In order to achieve this, I might
                    need to modularize the side-effects and have separate logic for them. This is challenging because of
                    the dynamic nature of debuffs; the target can change, it can last some number of turns, HP can be
                    given back and/or stolen, etc. With a strong, staticly-typed language like OCaml, there isn't a
                    great way to generalize these possibilities beautifully.</p>
            </div>
        </div>

        <!-- Footer -->
        <footer id="footer">
            <ul class="icons">
                <li><a href="https://www.youtube.com/channel/UCzYROYODhbwiBhnEj2cxiZA" target="_blank"
                        rel="noopener noreferrer" class="icon brands alt fa-youtube"><span
                            class="label">YouTube</span></a>
                </li>
                <li><a href="https://www.linkedin.com/in/robert-zhao-037247190/" target="_blank"
                        rel="noopener noreferrer" class="icon brands alt fa-linkedin-in"><span
                            class="label">LinkedIn</span></a></li>
                <li><a href="https://github.com/robertzhao2002?tab=repositories" target="_blank"
                        rel="noopener noreferrer" class="icon brands alt fa-github"><span
                            class="label">GitHub</span></a></li>
                <li><a href="mailto:rzhao1234@gmail.com" class="icon solid alt fa-envelope"><span
                            class="label">Email</span></a>
                </li>
            </ul>
            <ul class="copyright">
                <li>&copy; Robert Zhao.</li>
                <li>Website Code: <a href="https://github.com/robertzhao2002/robertzhao2002.github.io"
                        target="_blank">here</a></li>
            </ul>
        </footer>

    </div>

    <!-- Scripts -->
    <script src="assets/js/jquery.min.js"></script>
    <script src="assets/js/jquery.scrolly.min.js"></script>
    <script src="assets/js/jquery.dropotron.min.js"></script>
    <script src="assets/js/jquery.scrollex.min.js"></script>
    <script src="assets/js/browser.min.js"></script>
    <script src="assets/js/breakpoints.min.js"></script>
    <script src="assets/js/util.js"></script>
    <script src="assets/js/main.js"></script>
</body>

</html>